#! python3
# openxlsx.py - read all data from


import openpyxl, pprint, datetime


def collect_headers(file_name, sheet_name):
    wb = openpyxl.load_workbook(file_name)
    sheet = wb.get_sheet_by_name(sheet_name)

    headers = []

    for column in range(0, sheet.max_column):
        title = sheet[chr(ord('A') + column) + str(1)].value
        headers.append(title)
    return headers

def format_phone_number(phone_number):
    normalized_phone_number = phone_number[1:]
    return normalized_phone_number

def which_column(file_name, sheet_name, column_to_search):
    headers = collect_headers(file_name, sheet_name)

    for i, val in enumerate(headers):
        if val == column_to_search:
            return chr(ord('A') + i)


def get_how_many_rows(file_name, sheet_name):
    wb = openpyxl.load_workbook(file_name)
    sheet = wb.get_sheet_by_name(sheet_name)

    for row in range(2, sheet.max_column + 1):
        if sheet['A' + str(row)].internal_value != None:
            max_number = row
            # print(max_number)
    return max_number


def read_all_data(file_name, sheet_name):
    print('Opening workbook...')
    wb = openpyxl.load_workbook(file_name)
    sheet = wb.get_sheet_by_name(sheet_name)
    sheet_data = []

    print('Reading rows...')
    # Reading header row
    header_array = collect_headers(file_name, sheet_name)
    max_row_number = get_how_many_rows(file_name, sheet_name)
    #print('rows= ', max_row_number)
    # print('rows= ', sheet.max_row)
    #print('columns= ', sheet.max_column)

    row_content = {}
    for row in range(2, max_row_number):
        for column in range(0, sheet.max_column):
            cell_value = sheet[chr(ord('A') + column) + str(row)].value
            row_content[header_array[column]] = cell_value
        sheet_data.append(row_content)
        print(row_content)

    print(sheet_data)

    # TODO: Open a new text file and write the contents of countyData to it.


def get_matching_rows_id_by_column(file_name, sheet_name, column_to_check, search_value):
    matching_column_id = []

    print('Opening workbook...')
    wb = openpyxl.load_workbook(file_name)
    sheet = wb.get_sheet_by_name(sheet_name)
    max_row_number = get_how_many_rows(file_name, sheet_name)

    for row in range(2, max_row_number + 1):
        if search_value == sheet[column_to_check + str(row)].value:
            matching_column_id.append(row)
    return matching_column_id

def get_matching_rows_id_by_time_interval(file_name, sheet_name, column_to_check, interval):
    matching_column_id = []

    print('Opening workbook...')
    wb = openpyxl.load_workbook(file_name)
    sheet = wb.get_sheet_by_name(sheet_name)
    max_row_number = get_how_many_rows(file_name, sheet_name)

    current_date = datetime.datetime.now()
    input_var = int(input("Enter how many days in the future (default = 7 days) : ") or interval)
    print(current_date)
    filter_end_date = current_date + datetime.timedelta(days=input_var)

    for row in range(2, max_row_number + 1):
        if current_date <= sheet[column_to_check + str(row)].value <= filter_end_date:
            matching_column_id.append(row)
    return matching_column_id

def get_all_programs_for_group(file_name, sheet_name, column_to_check, search_value, tour_lead_column, tour_leader):
    matching_column_id = []

    wb = openpyxl.load_workbook(file_name)
    sheet = wb.get_sheet_by_name(sheet_name)
    max_row_number = get_how_many_rows(file_name, sheet_name)

    for row in range(2, max_row_number + 1):
        if (search_value == sheet[column_to_check + str(row)].value and tour_leader == sheet[tour_lead_column + str(row)].value):
            matching_column_id.append(row)
    return matching_column_id

def search_data_by_row(file_name, sheet_name, row_id):
    wb = openpyxl.load_workbook(file_name)
    sheet = wb.get_sheet_by_name(sheet_name)
    row_content = {}
    search_result = []
    header_array = collect_headers(file_name, sheet_name)
    #print(header_array)

    if row_id:
        for i, row_id in enumerate(row_id):
            for column in range(0, sheet.max_column):
                cell_value = sheet[chr(ord('A') + column) + str(row_id)].value
                if header_array[column] == 'Phone number':
                    cell_value = format_phone_number(cell_value)
                row_content[header_array[column]] = cell_value
                #print(row_content)
            search_result.append(dict(row_content))
        #print(search_result)
        return search_result
    return False


# TODO: Search Tour Leader contact details
#result_column = which_column('c:\Python\Twintours szingapur\Twintours 2018 Szingapur.xlsx', 'Turakiserok', 'Short name')
#search_rows_id = get_matching_rows_id_by_column('c:\Python\Twintours szingapur\Twintours 2018 Szingapur.xlsx', 'Turakiserok', result_column, 'Sam')
#result = search_data_by_row('c:\Python\Twintours szingapur\Twintours 2018 Szingapur.xlsx', 'Turakiserok', search_rows_id)
#print(result)

# TODO: Search Idegenvezetok contact details
#result_column = which_column('c:\Python\Twintours szingapur\Twintours 2018 Szingapur.xlsx', 'Idegenvezetok', 'Short name')
#search_rows_id = get_matching_rows_id_by_column('c:\Python\Twintours szingapur\Twintours 2018 Szingapur.xlsx', 'Idegenvezetok', result_column, 'Ancsi')
#result = search_data_by_row('c:\Python\Twintours szingapur\Twintours 2018 Szingapur.xlsx', 'Idegenvezetok', search_rows_id)
#print(result)

# TODO: Search Program details
#result_column = which_column('c:\Python\Twintours szingapur\Twintours 2018 Szingapur.xlsx', 'Programs', 'Short name')
#search_rows_id = get_matching_rows_id_by_column('c:\Python\Twintours szingapur\Twintours 2018 Szingapur.xlsx', 'Programs', result_column, '3h Budapest Sightseeing')
#result = search_data_by_row('c:\Python\Twintours szingapur\Twintours 2018 Szingapur.xlsx', 'Programs', search_rows_id)
#print(result)

# TODO: Search Restaurant details
#result_column = which_column('c:\Python\Twintours szingapur\Twintours 2018 Szingapur.xlsx', 'Restaurants', 'Name')
#search_rows_id = get_matching_rows_id_by_column('c:\Python\Twintours szingapur\Twintours 2018 Szingapur.xlsx', 'Restaurants', result_column, 'Inyenckert')
#result = search_data_by_row('c:\Python\Twintours szingapur\Twintours 2018 Szingapur.xlsx', 'Restaurants', search_rows_id)
#print(result)

# TODO: Read all data from a sheet
#read_all_data('c:\Python\Twintours szingapur\Twintours 2018 Szingapur.xlsx','Programs')

# TODO: Collect all matching rows for a Tour Lead
#result_column = which_column('c:\Python\Twintours szingapur\Twintours 2018 Szingapur.xlsx', 'DB', 'Tour Leader contact')
#search_rows_id = get_matching_rows_id_by_column('c:\Python\Twintours szingapur\Twintours 2018 Szingapur.xlsx', 'DB', result_column, 'Sam')
#result = search_data_by_row('c:\Python\Twintours szingapur\Twintours 2018 Szingapur.xlsx', 'DB', search_rows_id)
#print(result)

# TODO: Collect all programs for a group (arrival date as input)
#current_date = datetime.datetime.now()
input_var = input("Enter date (2017-04-22): ")
input_date = datetime.datetime.strptime(input_var, '%Y-%m-%d')
#print(input_date, type(input_date))
#print(current_date)
#print(current_date - datetime.timedelta(days=3))
#target_date = datetime.date(2017, 4, 22)
#print('target date', target_date, type(target_date))
arrive_column = which_column('c:\Python\Twintours szingapur\Twintours 2018 Szingapur.xlsx', 'DB', 'Group arrival date')
#print(arrive_column, type(arrive_column))
tour_lead_column = which_column('c:\Python\Twintours szingapur\Twintours 2018 Szingapur.xlsx', 'DB', 'Tour Leader contact')
#print(tour_lead_column, type(tour_lead_column))
search_rows_id = get_all_programs_for_group('c:\Python\Twintours szingapur\Twintours 2018 Szingapur.xlsx', 'DB', arrive_column, input_date, tour_lead_column, 'Sam')
#print(search_rows_id)
result = search_data_by_row('c:\Python\Twintours szingapur\Twintours 2018 Szingapur.xlsx', 'DB', search_rows_id)
#print(result)


# TODO: Create sightseeing program message
#import template_programdetail
#param_program = {'Program Start Time': datetime.time(9, 15), 'Pax': 23.0, 'Location': 'Heroes', 'Program Date': datetime.datetime(2017, 4, 23, 0, 0), 'GroupId': None, 'Group arrival date': datetime.datetime(2017, 4, 22, 0, 0), 'IdVez': 'Ancsi', 'Going to': 'Krakkow', 'Program Finish Time': datetime.time(12, 15), 'No. of tour leader': 2.0, 'Program': '3h Budapest Sightseeing', 'Menu': None, 'Arrive from': 'Wien', 'Hotel': 'Novotel', 'Company': 'EU Holidays', 'Group departure date': datetime.datetime(2017, 4, 23, 0, 0), 'Tour Leader contact': 'Sam'}
#param_idvez = {'Phone number': '+36203402594', 'Preferred app': 'whatsapp', 'Name': 'Valami Ancsi', None: None, 'Short name': 'Ancsi'}
#param_program_detail = {'Length': '3h', 'Start location': "Heroe's Square", 'Short name': '3h Budapest Sightseeing', 'End location': 'TBD', 'Full name': '3h, Budapest Sightseeing', 'Details': "Heroe's Square - Andrassy Ave. - Basilica - Parliament - Castle", 'Location': None}
#template_programdetail.sigthseeing_program_message(param_program, param_idvez, param_program_detail)

# TODO: Create eating program message
#import template_programdetail
#param_program = {'GroupId': None, 'Pax': 23.0, 'Program': 'Folklor Dinner, Inyenckert', 'IdVez': None, 'Group departure date': datetime.datetime(2017, 4, 23, 0, 0), 'Group arrival date': datetime.datetime(2017, 4, 22, 0, 0), 'Tour Leader contact': 'Sam', 'Program Finish Time': datetime.time(22, 0), 'Going to': 'Krakkow', 'Location': 'Inyenckert', 'Program Date': datetime.datetime(2017, 4, 22, 0, 0), 'Hotel': 'Novotel', 'Program Start Time': datetime.time(19, 30), 'Menu': '22 Duck leg;3 Vegetarian', 'Arrive from': 'Wien', 'No. of tour leader': 2.0, 'Company': 'EU Holidays'}
#param_restaurant = {'Name': 'Inyenckert', 'Menu2 main course': 'Duck leg', 'Menu1 main course': 'Duck leg', 'Menu2 short name': 'Vegetarian', 'Menu1 1st course': 'Beef Gulas', 'Menu2 1st course': 'Vegetable soup', 'Web': 'http://inyenckert.hu/en/contact/', 'Address': 'Budapest, III.dist. Vörösvári út 131.', 'Menu1 short name': 'Duck leg', 'Phone number': '+36304761316'}
#template_programdetail.eating_program_message(param_program, param_restaurant)


# TODO: Collect upcoming groups in X days
#current_date = datetime.datetime.now()
#input_var = int(input("Enter how many days in the future (default = 7 days) : ") or "7")
#print(current_date)
#print(current_date + datetime.timedelta(days=input_var))
#arrive_date_column = which_column('c:\Python\Twintours szingapur\Twintours 2018 Szingapur.xlsx', 'DB', 'Group arrival date')
#print(arrive_date_column)
#search_rows_id = get_matching_rows_id_by_time_interval('c:\Python\Twintours szingapur\Twintours 2018 Szingapur.xlsx', 'DB', arrive_date_column, 7)
#print(search_rows_id)
#result = search_data_by_row('c:\Python\Twintours szingapur\Twintours 2018 Szingapur.xlsx', 'DB', search_rows_id)
#print(result)

# TODO: Send SMS
# import sendMessage
# sendMessage.sendSMS('+36302873304','Szia Mano! Tudok kuldeni fasza SMSt mar a szamitogeprol! :)')

# TODO: Send Whatsapp
#import runpy
#runpy.send_message(36209849140, 'Faszom')

# TODO: Fill summary template mail
#import template
#result = summary